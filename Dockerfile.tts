FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

ENV PIP_DISABLE_PIP_VERSION_CHECK=1 PIP_PREFER_BINARY=1 \
    PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1 \
    DEBIAN_FRONTEND=noninteractive

# 1) Cài Python + audio libs + toolchain build
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3.10 python3.10-venv python3.10-distutils python3.10-dev \
    build-essential pkg-config \
    ffmpeg sox libsndfile1 ca-certificates curl \
    && rm -rf /var/lib/apt/lists/*

RUN curl -sS https://bootstrap.pypa.io/get-pip.py | python3.10

WORKDIR /srv
COPY requirements-tts.txt .
COPY tts-constraints.txt .

# 2) Venv + cài pre-reqs rồi mới install requirements
RUN python3.10 -m venv /opt/venv && . /opt/venv/bin/activate && \
    pip install --upgrade pip wheel && \
    # Cài sẵn nền tảng theo constraints (đảm bảo pyarrow build/ABI theo numpy 1.26)
    pip install -c tts-constraints.txt "numpy==1.26.4" "pyarrow==12.0.1" "pandas==2.2.2" \
                "typing_extensions>=4.8.0" "Cython>=0.29" && \
    # Cài toàn bộ requirements, nhưng giữ constraints & tắt build isolation
    pip install --no-cache-dir -r requirements-tts.txt -c tts-constraints.txt --no-build-isolation && \
    # Kiểm tra ngay ở build-time (fail sớm nếu NumPy bị nâng)
    python - <<'PY'
import numpy, pyarrow, pandas
print("NUMPY=", numpy.__version__)
print("PYARROW=", pyarrow.__version__)
print("PANDAS=", pandas.__version__)
assert numpy.__version__.startswith("1.26."), "NumPy đã bị nâng ngoài ý muốn!"
PY

ENV PATH="/opt/venv/bin:$PATH" PYTHONPATH=""

COPY tts_server/ ./tts_server

# 3) Pre-download/cache NeMo models to eliminate cold-start latency
#    Using English models as placeholders per the plan.
#    Replace with specific fine-tuned Vietnamese .nemo paths later.
RUN python - <<'PY'
import os
# Set cache dir to be within the build context
os.environ["NEMO_CACHE_DIR"] = "/opt/nemo_cache"
os.makedirs(os.environ["NEMO_CACHE_DIR"], exist_ok=True)
try:
    from nemo.collections.tts.models import FastPitchModel, HifiGanModel
    print("Pre-downloading NeMo FastPitch model...")
    FastPitchModel.from_pretrained("tts_en_fastpitch")
    print("Pre-downloading NeMo HiFiGAN model...")
    HifiGanModel.from_pretrained("nvidia/tts_hifigan")
    print("NeMo models pre-downloaded successfully.")
except Exception as e:
    print(f"Warning: Failed to pre-download NeMo models: {e}")
    print("This is expected if running offline or behind a restrictive firewall.")
    print("The application might try to download them at runtime instead.")
PY

# 4) (Optional) Clean up build toolchain to reduce final image size
#    Comment this out if you need the toolchain for later debugging.
RUN apt-get purge -y build-essential python3.10-dev pkg-config && \
    apt-get autoremove -y && \
    rm -rf /var/lib/apt/lists/*

HEALTHCHECK --interval=15s --timeout=3s --start-period=20s --retries=10 \
  CMD python -m tts_server.healthcheck

CMD ["python", "-m", "tts_server.api"]
